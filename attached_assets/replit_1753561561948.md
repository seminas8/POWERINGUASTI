# Powering guasti

## Overview

This is a full-stack web application for monitoring electrical grid outages in Italy. The system displays real outage information from Enel's API on an interactive map with advanced visualization capabilities. It's built with a React frontend, Express.js backend, and uses PostgreSQL with Drizzle ORM for data management.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Frontend Architecture
- **Framework**: React with TypeScript
- **Routing**: Wouter for client-side routing
- **UI Components**: shadcn/ui component library with Radix UI primitives
- **Styling**: Tailwind CSS with CSS variables for theming
- **State Management**: TanStack Query for server state management
- **Build Tool**: Vite for development and production builds
- **Map Integration**: Leaflet for interactive map visualization

### Backend Architecture
- **Framework**: Express.js with TypeScript
- **API**: RESTful API with JSON responses
- **Database**: PostgreSQL with Drizzle ORM
- **Session Management**: Uses connect-pg-simple for PostgreSQL session storage
- **Build**: ESBuild for production bundling

### Project Structure
- **Monorepo**: Shared schema and types between client and server
- **Client**: Frontend application in `/client` directory
- **Server**: Backend API in `/server` directory
- **Shared**: Common schemas and types in `/shared` directory

## Key Components

### Database Schema (shared/schema.ts)
- **Users Table**: Basic user authentication with username/password
- **Outages Table**: Comprehensive outage tracking with geolocation, status, timeline, and affected user counts
- **Validation**: Zod schemas for type-safe data validation

### API Layer (server/routes.ts)
- **GET /api/outages**: Fetches outage data from external API or returns demo data
- **GET /api/health**: Health check endpoint
- **Error Handling**: Centralized error handling with appropriate HTTP status codes

### Frontend Components
- **MapContainer**: Interactive map with Leaflet showing outage markers
- **OutageDetails**: Detailed view of selected outages with timeline
- **FilterPanel**: Filtering options by status, zone, and other criteria
- **ApiKeyInput**: Secure API key configuration interface
- **Header**: Navigation and search functionality

### External API Integration (client/src/lib/api.ts)
- **OutageAPI Class**: Handles external energy grid API communication
- **Fallback System**: Returns demo data when external API is unavailable
- **Data Transformation**: Maps external API data to internal schema format

## Data Flow

1. **API Key Configuration**: User enters API key through secure input form
2. **Data Fetching**: TanStack Query manages API calls to `/api/outages`
3. **Backend Proxy**: Express server acts as proxy to external energy grid API
4. **Data Transformation**: API response is transformed to match internal schema
5. **Map Visualization**: Outage data is displayed as markers on Leaflet map
6. **User Interaction**: Clicking markers shows detailed outage information
7. **Real-time Updates**: Periodic refresh of outage data with loading states

## External Dependencies

### Core Dependencies
- **@neondatabase/serverless**: Neon database connectivity
- **drizzle-orm**: Type-safe database ORM
- **@tanstack/react-query**: Server state management
- **leaflet**: Interactive mapping (dynamically imported)
- **express**: Backend web framework

### UI Dependencies
- **@radix-ui/***: Accessible UI primitives
- **tailwindcss**: Utility-first CSS framework
- **lucide-react**: Icon library
- **date-fns**: Date manipulation utilities

### Development Dependencies
- **vite**: Frontend build tool
- **tsx**: TypeScript execution for development
- **esbuild**: Backend bundling for production

## Deployment Strategy

### Development
- **Frontend**: Vite dev server with HMR (Hot Module Replacement)
- **Backend**: TSX for TypeScript execution with automatic restart
- **Database**: Drizzle migrations with `db:push` command

### Production Build
- **Frontend**: Vite build outputs to `dist/public`
- **Backend**: ESBuild bundles server code to `dist/index.js`
- **Deployment**: Single Node.js process serving both API and static files

### Environment Configuration
- **Database**: PostgreSQL connection via `DATABASE_URL`
- **API**: External API key via `ENERGY_GRID_API_KEY` or user input
- **Build**: Separate development and production configurations

### Key Features
- **Real-time Data**: Integrated with Enel's official API for authentic outage data
- **Advanced Mapping**: Full OpenStreetMap functionality with layer switching, geolocation, distance measurement
- **Responsive Design**: Mobile-friendly interface with touch support
- **Progressive Enhancement**: Fallback to demo data when external API unavailable
- **Accessibility**: ARIA-compliant components via Radix UI
- **Type Safety**: End-to-end TypeScript with shared schemas
- **Error Handling**: Graceful degradation with user-friendly error messages

## Recent Changes (July 2025)
- ✓ Integrated real Enel API for authentic outage data (1000+ active outages)
- ✓ Added multiple map layers: Standard, Humanitarian, CartoDB, Satellite
- ✓ Implemented geolocation with "Find my position" control
- ✓ Added distance measurement tool with click-to-measure functionality
- ✓ Enhanced with scale display, coordinates tracking, and fullscreen mode
- ✓ Removed management buttons (Assegna Squadra, Condividi) for read-only interface
- ✓ Improved outage details with highlighted "Clienti disalimentati" count
- ✓ Renamed application from "Energy Grid Monitor" to "Powering guasti"
- ✓ Added specific location control for Sellia Marina, Calabria
- ✓ Optimized GPS accuracy with high precision settings
- ✓ Fixed iOS Safari fullscreen compatibility with custom CSS fallback
- ✓ Removed search functionality for cleaner interface
- ✓ Removed priority filters, kept only status and zone filters
- ✓ Added keep-alive system to prevent Replit from sleeping
- ✓ Created monitoring endpoints for external uptime services
- ✓ Implemented offline support with Service Worker for static caching
- ✓ Added connection status detection and user notifications
- ✓ Enhanced error handling with clear offline messaging

## Keep-Alive System
To keep the app running 24/7 without official deployment:

### Internal Keep-Alive
- Self-ping every 5 minutes to `/api/health` endpoint
- Automatic activation when server starts
- Prevents Replit from sleeping due to inactivity

### External Monitoring Options
Use free uptime monitoring services to ping the app:

1. **UptimeRobot** (free tier: 50 monitors)
   - URL to monitor: `https://your-repl-url.replit.dev/ping`
   - Check interval: 5 minutes
   - Creates external traffic to keep app active

2. **Pingdom** (free tier: 10 checks)
   - Monitor the `/ping` endpoint
   - Set up email alerts for downtime

3. **StatusCake** (free tier: 10 tests)
   - HTTP monitoring of `/ping` endpoint
   - Dashboard for uptime statistics

4. **Freshping** (free tier: 50 checks)
   - Simple ping monitoring
   - Team collaboration features

### Setup Instructions
1. Get your Replit app URL (format: `https://project-name.username.replit.dev`)
2. Sign up for a free monitoring service
3. Add your app URL with `/ping` endpoint
4. Set check interval to 5-10 minutes
5. Configure email notifications for downtime alerts

This combination ensures maximum uptime without paid hosting.

## Offline Support

### Service Worker Implementation
- **Static Caching**: App shell and resources cached for offline access
- **Manifest**: PWA-ready with app manifest and icons
- **Fallback Strategy**: Graceful degradation when API unavailable

### User Experience
- **Connection Status**: Real-time detection of online/offline state
- **Visual Indicators**: Clear messaging when connection is lost
- **Progressive Enhancement**: Core app interface works offline
- **Data Requirements**: Outage data requires internet connection (external API dependency)

### Technical Details
- Service Worker registration in main app component
- Connection status hook using navigator.onLine API
- Error boundaries with specific offline messaging
- Toast notifications for connection state changes